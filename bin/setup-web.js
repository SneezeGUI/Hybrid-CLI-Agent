#!/usr/bin/env node
/**
 * Web-based Setup GUI for Hybrid-CLI-Agent
 *
 * Run with: npm run setup:web
 * Or directly: node bin/setup-web.js
 *
 * Opens a browser window with a configuration form.
 */

import { createServer } from 'http';
import { writeFileSync, existsSync, mkdirSync, readFileSync } from 'fs';
import { join, resolve, dirname } from 'path';
import { homedir } from 'os';
import { fileURLToPath } from 'url';
import open from 'open';
import { loadEnvFileSync } from '../src/utils/env.js';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
const PROJECT_ROOT = resolve(__dirname, '..');

const PORT = 8877;
const ENV_FILE = join(PROJECT_ROOT, '.env');
const CLAUDE_SETTINGS_DIR = join(homedir(), '.claude');
const CLAUDE_SETTINGS_FILE = join(CLAUDE_SETTINGS_DIR, 'settings.json');
const MCP_SERVER_SCRIPT = join(PROJECT_ROOT, 'src', 'mcp', 'gemini-mcp-server.js');

/**
 * Escape HTML to prevent XSS attacks
 */
function escapeHtml(str) {
  if (!str || typeof str !== 'string') return '';
  return str
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

/**
 * Load existing .env file using shared utility
 */
function loadEnvFile() {
  return loadEnvFileSync(PROJECT_ROOT);
}

/**
 * Save .env file
 */
function saveEnvFile(env) {
  const lines = [
    '# Hybrid-CLI-Agent Configuration',
    '# Generated by setup wizard',
    '',
    '# Authentication',
    `GEMINI_API_KEY=${env.GEMINI_API_KEY || ''}`,
    `GOOGLE_API_KEY=${env.GOOGLE_API_KEY || ''}`,
    `VERTEX_API_KEY=${env.VERTEX_API_KEY || ''}`,
    '',
    '# OpenRouter',
    `OPENROUTER_API_KEY=${env.OPENROUTER_API_KEY || ''}`,
    '',
    '# Features',
    `GEMINI_AGENT_MODE=${env.GEMINI_AGENT_MODE || 'false'}`,
    '',
  ];
  writeFileSync(ENV_FILE, lines.join('\n'));
}

/**
 * Register with Claude Code
 */
function registerWithClaude() {
  if (!existsSync(CLAUDE_SETTINGS_DIR)) {
    mkdirSync(CLAUDE_SETTINGS_DIR, { recursive: true });
  }

  let settings = {};
  if (existsSync(CLAUDE_SETTINGS_FILE)) {
    try {
      settings = JSON.parse(readFileSync(CLAUDE_SETTINGS_FILE, 'utf-8'));
    } catch (e) {
      // Ignore
    }
  }

  if (!settings.mcpServers) {
    settings.mcpServers = {};
  }

  settings.mcpServers['hybrid-agent'] = {
    command: 'node',
    args: [MCP_SERVER_SCRIPT],
    cwd: PROJECT_ROOT,
  };

  writeFileSync(CLAUDE_SETTINGS_FILE, JSON.stringify(settings, null, 2));
  return true;
}

/**
 * Parse URL-encoded form data
 */
function parseFormData(body) {
  const params = new URLSearchParams(body);
  const data = {};
  for (const [key, value] of params) {
    data[key] = value;
  }
  return data;
}

/**
 * HTML template
 */
function getHtml(env) {
  return `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hybrid-CLI-Agent - Setup</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 2rem;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    header {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: white;
      padding: 2rem;
      text-align: center;
    }
    header h1 { font-size: 1.5rem; margin-bottom: 0.5rem; }
    header p { opacity: 0.8; font-size: 0.9rem; }
    .form-section {
      padding: 2rem;
      border-bottom: 1px solid #eee;
    }
    .form-section:last-child { border-bottom: none; }
    .form-section h2 {
      font-size: 1rem;
      color: #333;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .form-group {
      margin-bottom: 1rem;
    }
    label {
      display: block;
      font-size: 0.85rem;
      color: #666;
      margin-bottom: 0.25rem;
    }
    input[type="text"], input[type="password"] {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.2s;
    }
    input:focus {
      outline: none;
      border-color: #667eea;
    }
    .hint {
      font-size: 0.75rem;
      color: #888;
      margin-top: 0.25rem;
    }
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem;
      background: #f8f9fa;
      border-radius: 8px;
      margin-bottom: 0.5rem;
    }
    .checkbox-group input[type="checkbox"] {
      width: 18px;
      height: 18px;
    }
    .checkbox-group label {
      margin: 0;
      color: #333;
    }
    button {
      width: 100%;
      padding: 1rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    .status {
      padding: 1rem 2rem;
      background: #d4edda;
      color: #155724;
      display: none;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
    }
    .auth-methods {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .auth-method {
      flex: 1;
      padding: 0.75rem;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    .auth-method:hover { border-color: #667eea; }
    .auth-method.selected {
      border-color: #667eea;
      background: #f0f3ff;
    }
    .auth-method span { display: block; font-size: 1.5rem; margin-bottom: 0.25rem; }
    .auth-method small { font-size: 0.7rem; color: #666; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ğŸ¤– Hybrid-CLI-Agent</h1>
      <p>Configuration Wizard</p>
    </header>

    <div id="status" class="status"></div>

    <form id="configForm" method="POST" action="/save">
      <div class="form-section">
        <h2>ğŸ” Authentication</h2>

        <div class="auth-methods">
          <div class="auth-method ${!env.GEMINI_API_KEY && !env.VERTEX_API_KEY ? 'selected' : ''}" data-method="oauth" onclick="selectAuth('oauth')">
            <span>ğŸ”“</span>
            <div>OAuth</div>
            <small>Free (Pro/Ultra)</small>
          </div>
          <div class="auth-method ${env.GEMINI_API_KEY ? 'selected' : ''}" data-method="api-key" onclick="selectAuth('api-key')">
            <span>ğŸ”‘</span>
            <div>API Key</div>
            <small>makersuite.google.com</small>
          </div>
          <div class="auth-method ${env.VERTEX_API_KEY ? 'selected' : ''}" data-method="vertex" onclick="selectAuth('vertex')">
            <span>â˜ï¸</span>
            <div>Vertex AI</div>
            <small>Enterprise</small>
          </div>
        </div>

        <div id="apiKeyGroup" class="form-group" style="${env.GEMINI_API_KEY ? '' : 'display:none'}">
          <label for="GEMINI_API_KEY">Gemini API Key</label>
          <input type="password" id="GEMINI_API_KEY" name="GEMINI_API_KEY" value="${escapeHtml(env.GEMINI_API_KEY || '')}" placeholder="AI...">
          <div class="hint">Get from <a href="https://makersuite.google.com/app/apikey" target="_blank">makersuite.google.com</a></div>
        </div>

        <div id="vertexKeyGroup" class="form-group" style="${env.VERTEX_API_KEY ? '' : 'display:none'}">
          <label for="VERTEX_API_KEY">Vertex AI API Key</label>
          <input type="password" id="VERTEX_API_KEY" name="VERTEX_API_KEY" value="${escapeHtml(env.VERTEX_API_KEY || '')}" placeholder="AQ...">
        </div>

        <input type="hidden" id="authMethod" name="authMethod" value="${escapeHtml(env.VERTEX_API_KEY ? 'vertex' : env.GEMINI_API_KEY ? 'api-key' : 'oauth')}">
      </div>

      <div class="form-section">
        <h2>ğŸŒ OpenRouter (Optional)</h2>
        <div class="form-group">
          <label for="OPENROUTER_API_KEY">OpenRouter API Key</label>
          <input type="password" id="OPENROUTER_API_KEY" name="OPENROUTER_API_KEY" value="${escapeHtml(env.OPENROUTER_API_KEY || '')}" placeholder="sk-or-...">
          <div class="hint">Access 400+ AI models. Get from <a href="https://openrouter.ai" target="_blank">openrouter.ai</a></div>
        </div>
      </div>

      <div class="form-section">
        <h2>âš™ï¸ Features</h2>
        <div class="checkbox-group">
          <input type="checkbox" id="GEMINI_AGENT_MODE" name="GEMINI_AGENT_MODE" ${env.GEMINI_AGENT_MODE === 'true' ? 'checked' : ''}>
          <label for="GEMINI_AGENT_MODE">Enable Agent Mode (allows Gemini to use tools)</label>
        </div>
        <div class="checkbox-group">
          <input type="checkbox" id="registerClaude" name="registerClaude" checked>
          <label for="registerClaude">Register with Claude Code</label>
        </div>
      </div>

      <div class="form-section">
        <button type="submit">ğŸ’¾ Save Configuration</button>
      </div>
    </form>
  </div>

  <script>
    function selectAuth(method) {
      document.querySelectorAll('.auth-method').forEach(el => el.classList.remove('selected'));
      document.querySelector('[data-method="' + method + '"]').classList.add('selected');
      document.getElementById('authMethod').value = method;

      document.getElementById('apiKeyGroup').style.display = method === 'api-key' ? '' : 'none';
      document.getElementById('vertexKeyGroup').style.display = method === 'vertex' ? '' : 'none';

      // Clear keys not being used
      if (method !== 'api-key') document.getElementById('GEMINI_API_KEY').value = '';
      if (method !== 'vertex') document.getElementById('VERTEX_API_KEY').value = '';
    }

    document.getElementById('configForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const params = new URLSearchParams();
      for (const [key, value] of formData) {
        params.append(key, value);
      }

      try {
        const res = await fetch('/save', { method: 'POST', body: params });
        const text = await res.text();
        const status = document.getElementById('status');
        status.style.display = 'block';
        status.className = res.ok ? 'status' : 'status error';
        status.innerHTML = text;

        if (res.ok) {
          setTimeout(() => window.close(), 3000);
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    });
  </script>
</body>
</html>`;
}

/**
 * Create HTTP server
 */
const server = createServer((req, res) => {
  if (req.method === 'GET' && req.url === '/') {
    const env = loadEnvFile();
    res.writeHead(200, { 'Content-Type': 'text/html' });
    res.end(getHtml(env));
  } else if (req.method === 'POST' && req.url === '/save') {
    let body = '';
    req.on('data', chunk => { body += chunk.toString(); });
    req.on('end', () => {
      try {
        const data = parseFormData(body);

        const newEnv = {
          GEMINI_API_KEY: data.GEMINI_API_KEY || '',
          VERTEX_API_KEY: data.VERTEX_API_KEY || '',
          OPENROUTER_API_KEY: data.OPENROUTER_API_KEY || '',
          GEMINI_AGENT_MODE: data.GEMINI_AGENT_MODE === 'on' ? 'true' : 'false',
        };

        saveEnvFile(newEnv);

        let message = 'âœ… Configuration saved!';
        if (data.registerClaude === 'on') {
          registerWithClaude();
          message += '<br>âœ… Registered with Claude Code.<br><br>ğŸ”„ Restart Claude Code to apply changes.';
        }
        message += '<br><br>This window will close in 3 seconds...';

        res.writeHead(200, { 'Content-Type': 'text/html' });
        res.end(message);

        // Shutdown after save
        setTimeout(() => {
          console.log('\nâœ… Configuration saved. Shutting down setup server.');
          process.exit(0);
        }, 1000);
      } catch (err) {
        res.writeHead(500, { 'Content-Type': 'text/html' });
        res.end('âŒ Error: ' + err.message);
      }
    });
  } else {
    res.writeHead(404);
    res.end('Not found');
  }
});

server.listen(PORT, () => {
  const url = `http://localhost:${PORT}`;
  console.log(`
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘       Hybrid-CLI-Agent - Web Setup                           â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Opening browser to: ${url}                        â•‘
â•‘  Press Ctrl+C to cancel                                      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
`);
  open(url);
});
