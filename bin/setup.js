#!/usr/bin/env node
/**
 * Interactive Setup Wizard for Hybrid-CLI-Agent
 *
 * Run with: npm run setup
 * Or directly: node bin/setup.js
 */

import inquirer from 'inquirer';
import { writeFileSync, existsSync, mkdirSync, readFileSync } from 'fs';
import { join, resolve, dirname } from 'path';
import { spawn } from 'child_process';
import { homedir } from 'os';
import { fileURLToPath } from 'url';
import { loadEnvFileSync } from '../src/utils/env.js';
import { CLI_TIMEOUTS } from '../src/config/timeouts.js';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
const PROJECT_ROOT = resolve(__dirname, '..');

// Paths
const ENV_FILE = join(PROJECT_ROOT, '.env');
const CLAUDE_SETTINGS_DIR = join(homedir(), '.claude');
const CLAUDE_SETTINGS_FILE = join(CLAUDE_SETTINGS_DIR, 'settings.json');
const MCP_SERVER_SCRIPT = join(PROJECT_ROOT, 'src', 'mcp', 'gemini-mcp-server.js');

// Colors for console output
const colors = {
  reset: '\x1b[0m',
  bright: '\x1b[1m',
  green: '\x1b[32m',
  yellow: '\x1b[33m',
  blue: '\x1b[34m',
  cyan: '\x1b[36m',
  red: '\x1b[31m',
};

function log(msg, color = '') {
  console.log(`${color}${msg}${colors.reset}`);
}

function banner() {
  console.log(`
${colors.cyan}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘       ${colors.bright}Hybrid-CLI-Agent - Setup Wizard${colors.reset}${colors.cyan}                       â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Configure API keys, authentication, and Claude integration  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${colors.reset}
`);
}

/**
 * Load existing .env file using shared utility
 */
function loadEnvFile() {
  return loadEnvFileSync(PROJECT_ROOT);
}

/**
 * Save .env file
 */
function saveEnvFile(env) {
  const lines = [
    '# Hybrid-CLI-Agent Configuration',
    '# Generated by setup wizard',
    '',
    '# Authentication (choose one method)',
    `GEMINI_API_KEY=${env.GEMINI_API_KEY || ''}`,
    `GOOGLE_API_KEY=${env.GOOGLE_API_KEY || ''}`,
    `VERTEX_API_KEY=${env.VERTEX_API_KEY || ''}`,
    '',
    '# OpenRouter (optional - for 400+ model access)',
    `OPENROUTER_API_KEY=${env.OPENROUTER_API_KEY || ''}`,
    '',
    '# Features',
    `GEMINI_AGENT_MODE=${env.GEMINI_AGENT_MODE || 'false'}`,
    '',
  ];
  writeFileSync(ENV_FILE, lines.join('\n'));
  log(`\nâœ… Configuration saved to ${ENV_FILE}`, colors.green);
}

/**
 * Load Claude settings
 */
function loadClaudeSettings() {
  if (existsSync(CLAUDE_SETTINGS_FILE)) {
    try {
      return JSON.parse(readFileSync(CLAUDE_SETTINGS_FILE, 'utf-8'));
    } catch (e) {
      return {};
    }
  }
  return {};
}

/**
 * Save Claude settings
 */
function saveClaudeSettings(settings) {
  if (!existsSync(CLAUDE_SETTINGS_DIR)) {
    mkdirSync(CLAUDE_SETTINGS_DIR, { recursive: true });
  }
  writeFileSync(CLAUDE_SETTINGS_FILE, JSON.stringify(settings, null, 2));
}

/**
 * Check if Gemini CLI is installed
 */
async function checkGeminiCli() {
  return new Promise((resolve) => {
    const proc = spawn('gemini', ['--version'], { shell: true });
    proc.on('close', (code) => resolve(code === 0));
    proc.on('error', () => resolve(false));
  });
}

/**
 * Check if Gemini OAuth is authenticated
 */
async function checkGeminiOAuth() {
  return new Promise((resolve) => {
    const proc = spawn('gemini', ['auth', 'status'], { shell: true });
    let output = '';
    proc.stdout.on('data', (d) => { output += d.toString(); });
    proc.stderr.on('data', (d) => { output += d.toString(); });
    proc.on('close', (code) => {
      resolve({
        authenticated: code === 0,
        output: output.trim(),
      });
    });
    proc.on('error', () => resolve({ authenticated: false, output: 'CLI not found' }));
  });
}

/**
 * Test Gemini authentication
 */
async function testGeminiAuth() {
  return new Promise((resolve) => {
    const proc = spawn('gemini', ['--model', 'gemini-2.5-flash', '--output-format', 'text'], {
      shell: true,
      timeout: CLI_TIMEOUTS.AUTH_SPAWN,
    });

    let output = '';
    proc.stdout.on('data', (d) => { output += d.toString(); });
    proc.stderr.on('data', (d) => { output += d.toString(); });

    proc.on('close', (code) => {
      resolve({ success: code === 0, output });
    });
    proc.on('error', (err) => {
      resolve({ success: false, output: err.message });
    });

    // Send a simple test prompt
    proc.stdin.write('Say "OK" and nothing else');
    proc.stdin.end();

    // Timeout after configured duration
    setTimeout(() => {
      proc.kill();
      resolve({ success: false, output: 'Timeout' });
    }, CLI_TIMEOUTS.AUTH_TEST);
  });
}

/**
 * Main setup wizard
 */
async function runSetup() {
  banner();

  const existingEnv = loadEnvFile();

  // Step 1: Check prerequisites
  log('ðŸ“‹ Checking prerequisites...', colors.blue);

  const geminiInstalled = await checkGeminiCli();
  if (geminiInstalled) {
    log('   âœ… Gemini CLI is installed', colors.green);
  } else {
    log('   âš ï¸  Gemini CLI not found. Install from: https://github.com/google-gemini/gemini-cli', colors.yellow);
    log('      Or run: npm install -g @google/gemini-cli', colors.yellow);
  }

  // Check OAuth status
  let oauthAuthenticated = false;
  if (geminiInstalled) {
    const oauthStatus = await checkGeminiOAuth();
    oauthAuthenticated = oauthStatus.authenticated;
    if (oauthAuthenticated) {
      log('   âœ… OAuth is authenticated (gemini auth login)', colors.green);
    } else {
      log('   âš ï¸  OAuth not authenticated. Run: gemini auth login', colors.yellow);
    }
  }

  console.log('');

  // Step 2: Authentication method
  // Default to OAuth if already authenticated, otherwise check for existing keys
  const defaultAuth = oauthAuthenticated ? 'oauth' :
                      existingEnv.VERTEX_API_KEY ? 'vertex' :
                      existingEnv.GEMINI_API_KEY ? 'api-key' : 'oauth';

  const { authMethod } = await inquirer.prompt([
    {
      type: 'list',
      name: 'authMethod',
      message: 'Choose your authentication method:',
      choices: [
        {
          name: oauthAuthenticated
            ? 'ðŸ” OAuth (gemini auth login) - âœ… AUTHENTICATED - FREE, recommended'
            : 'ðŸ” OAuth (gemini auth login) - FREE, recommended for Pro/Ultra subscribers',
          value: 'oauth'
        },
        { name: 'ðŸ”‘ Gemini API Key - Get from makersuite.google.com', value: 'api-key' },
        { name: 'â˜ï¸  Vertex AI - For enterprise/higher limits', value: 'vertex' },
        { name: 'â­ï¸  Skip - I\'ll configure manually later', value: 'skip' },
      ],
      default: defaultAuth,
    },
  ]);

  const newEnv = { ...existingEnv };

  if (authMethod === 'oauth') {
    log('\nðŸ“ OAuth selected. Make sure you\'ve run: gemini auth login', colors.cyan);
    // Clear API keys for OAuth
    newEnv.GEMINI_API_KEY = '';
    newEnv.VERTEX_API_KEY = '';
  } else if (authMethod === 'api-key') {
    const { apiKey } = await inquirer.prompt([
      {
        type: 'password',
        name: 'apiKey',
        message: 'Enter your Gemini API Key:',
        mask: '*',
        default: existingEnv.GEMINI_API_KEY,
        validate: (input) => input.length > 10 || 'API key seems too short',
      },
    ]);
    newEnv.GEMINI_API_KEY = apiKey;
    newEnv.VERTEX_API_KEY = '';
  } else if (authMethod === 'vertex') {
    const { vertexKey } = await inquirer.prompt([
      {
        type: 'password',
        name: 'vertexKey',
        message: 'Enter your Vertex AI API Key:',
        mask: '*',
        default: existingEnv.VERTEX_API_KEY,
        validate: (input) => input.length > 10 || 'API key seems too short',
      },
    ]);
    newEnv.VERTEX_API_KEY = vertexKey;
    newEnv.GEMINI_API_KEY = '';
  }

  // Step 3: OpenRouter (optional)
  const { configureOpenRouter } = await inquirer.prompt([
    {
      type: 'confirm',
      name: 'configureOpenRouter',
      message: 'Configure OpenRouter for access to 400+ AI models? (optional)',
      default: !!existingEnv.OPENROUTER_API_KEY,
    },
  ]);

  if (configureOpenRouter) {
    const { openrouterKey } = await inquirer.prompt([
      {
        type: 'password',
        name: 'openrouterKey',
        message: 'Enter your OpenRouter API Key (from openrouter.ai):',
        mask: '*',
        default: existingEnv.OPENROUTER_API_KEY,
      },
    ]);
    newEnv.OPENROUTER_API_KEY = openrouterKey;
  }

  // Step 4: Agent mode
  const { enableAgentMode } = await inquirer.prompt([
    {
      type: 'confirm',
      name: 'enableAgentMode',
      message: 'Enable Gemini Agent Mode? (allows Gemini to use tools like file operations)',
      default: existingEnv.GEMINI_AGENT_MODE === 'true',
    },
  ]);
  newEnv.GEMINI_AGENT_MODE = enableAgentMode ? 'true' : 'false';

  // Save .env
  saveEnvFile(newEnv);

  // Step 5: Test authentication
  if (authMethod !== 'skip') {
    const { testAuth } = await inquirer.prompt([
      {
        type: 'confirm',
        name: 'testAuth',
        message: 'Test Gemini authentication now?',
        default: true,
      },
    ]);

    if (testAuth) {
      log('\nðŸ§ª Testing Gemini authentication...', colors.blue);
      const result = await testGeminiAuth();
      if (result.success) {
        log('   âœ… Authentication successful!', colors.green);
      } else {
        log('   âŒ Authentication failed. Check your credentials.', colors.red);
        log(`      ${result.output.substring(0, 200)}`, colors.yellow);
      }
    }
  }

  // Step 6: Claude Code integration
  console.log('');
  const { registerClaude } = await inquirer.prompt([
    {
      type: 'confirm',
      name: 'registerClaude',
      message: 'Register this server with Claude Code?',
      default: true,
    },
  ]);

  if (registerClaude) {
    const settings = loadClaudeSettings();

    if (!settings.mcpServers) {
      settings.mcpServers = {};
    }

    settings.mcpServers['hybrid-agent'] = {
      command: 'node',
      args: [MCP_SERVER_SCRIPT],
      cwd: PROJECT_ROOT,
    };

    saveClaudeSettings(settings);
    log(`\nâœ… Registered with Claude Code at ${CLAUDE_SETTINGS_FILE}`, colors.green);
    log('   Restart Claude Code to pick up the changes.', colors.cyan);
  }

  // Final summary
  console.log(`
${colors.cyan}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    ${colors.bright}Setup Complete!${colors.reset}${colors.cyan}                            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${colors.reset}

${colors.bright}Next steps:${colors.reset}
  1. Restart Claude Code (if registered)
  2. Test with: ${colors.cyan}npm run config${colors.reset}
  3. Start server manually: ${colors.cyan}npm run mcp${colors.reset}

${colors.bright}Available commands:${colors.reset}
  ${colors.cyan}npm run setup${colors.reset}    - Run this wizard again
  ${colors.cyan}npm run config${colors.reset}   - View current configuration
  ${colors.cyan}npm run mcp${colors.reset}      - Start MCP server
  ${colors.cyan}npm test${colors.reset}         - Run tests
`);
}

// Run
runSetup().catch((error) => {
  console.error('Setup error:', error.message);
  process.exit(1);
});
